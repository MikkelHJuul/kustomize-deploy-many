#!/bin/bash

debug=0

function debug() {
	if (($debug)); then
		echo "$1" >> debug.log
	fi
}

## common arguments
files_to_process=
command=$1
start="${2%/}"
if [[ $start != "$(pwd)"* ]]; then
	start="$(pwd)/$start"
fi
if [[ "$3" == *"debug" ]]; then
	debug=1
	shift
fi
debug "given kustomization location: $1"  #1 because of shift
debug "verified pwd to path: $start "
shift
shift
if [[ "$1" == "--" ]]; then
	shift
	debug "files to be processed: $@"
	files_to_process=$@
fi


function path_relative_to() {
	debug "will now find path: $2, relative to: $1"
	full_first_path="$(readlink -e $1)"
	debug "full-path: $full_first_path"
	echo $(cd "$full_first_path" && cd "$(readlink -e $2)" && pwd)
}

function resources_from_kustomization() {
	debug "stat resources: $1"
	local kustomization_file="$1/kustomization.y*ml"
	if [ -f $1/kustomization.y*ml ]; then
		local resources bases_str bases
		local replacement="$(echo "$1" | sed 's/\//\\\//g')\/"
		debug "replacement text: $replacement"
		resources="$(yq r $kustomization_file resources | sed -En "s/- /$replacement/p")"
		bases_str="$(yq r $kustomization_file bases | sed -En 's/- //p')"
		bases=($bases_str)
		debug "- bases: $bases_str"
		for base in "${bases[@]}"; do
			base="${base%/}"
			debug "-- base: $base"
			resources="$resources $(resources_from_kustomization $(path_relative_to $1 $base))"	
		done
		echo "$resources"
	else
		debug "no such file: $kustomization_file"
	fi
}

function extract_header_from() {
	debug "header: $(head -1 "$1")"
	echo "$(read_csv_line $(head -1 "$1"))"
}

function read_csv_line() {
	debug "csv hack: $(echo $1 | sed -r 's/("[^",]*),([^",]*")/\1###\2/g' | sed -r 's/,/造/g' | sed -r 's/###/,/g')"
	echo "$(echo $1 | sed -r 's/("[^",]*),([^",]*")/\1###\2/g' | sed -r 's/,/造/g' | sed -r 's/###/,/g')"  # hack to preserve commas
}


function find_csv_resources() {
	local csv_resources
	resource_list=($1)
	for resource in "${resource_list[@]}"; do
		resource_name=${resource%.*}
		if [[ -z "$resource_name.csv" ]]; then
			csv_resources="$csv_resources $resource_name.csv"
		fi
	done
	debug "found csv resources: $csv_resources"
	echo "$csv_resources"
}


function get_resources() {
	if [[ -z files_to_process ]]; then
		resource_str=$(resources_from_kustomization "$1")
		debug "resources, found: $resource_str"
		echo "$(find_csv_resources "$resource_str")"
	else 
		echo "$files_to_process"
	fi
}

function build_yamls() {
	debug "exploding yamls from list of csv-files"
	resource_list=($1)
	for resource in "${resource_list[@]}"; do
		resource_name=$(ls "${resource%.*}".y*ml)
		debug "backing up resource $resource, read csv"
		mv "$resource_name" "$resource_name.bak"
		rm -f "$resource_name"
		touch "$resource_name"
		head_str=$(extract_header_from "$resource")
		IFS="造" head=($head_str)
		debug "number of header-items found: ${#head[@]}"
		sed 1d "$resource" | while read line
		do
			IFS="造" values=($(read_csv_line "$line"))
			for ((i = 0; i < ${#head[@]}; ++i)); do
				if [[ ! -z "${head[$i]}" ]]; then
					debug "setting environment variable: ${head[$i]}, to value: ${values[$i]}"
					export "${head[$i]}"="${values[$i]}"
				fi
			done 
			envsubst < "$resource" >> "$resource_name"
			echo "" >> "$resource_name"
			echo "---" >> "$resource_name"
			done
		  	sed -i '$d' "$resource_name" 
		fi	
	done
	debug "yamls were built"
}

function clean_up() {
	debug "reverting .bak-files"
	resource_list=($1)
	for resource in "${resource_list[@]}"; do
		if [ -f "$resource.bak" ]; then
			debug "reverting file: $resource"
			mv "$resource.bak" "$resource"
			rm -f "$resource.bak"
		fi
	done
	debug "done reverting bakup-files"
}


function debug_session() {
	echo "Starting DEBUGGING session" > debug.log
	echo "======================" >> debug.log
}



case "$command" in
build)
	debug "building kustomization resources"
	build_yamls $(get_resources "$start")
	kubectl kustomize "$start"
;;
clean)
	debug "cleaning up resources"
	clean_up $(get_resources "$start")
	echo "done!"
	if (($debug)); then
		cat debug.log
	fi
;;
debug)
	debug_session
	debug "entered via debug method"
	$0 build "$start" --debug
	cat debug.log
;;
deploy)
	debug "deploying: $start"
	$0 build "$start" | envsubst | kubectl apply -f -
	if (($debug)); then
		cat debug.log
	fi
;;
*)
    echo "Usage: $0 {build|clean|debug|deploy} {my/path/to/kustomization/folder} [--debug] [-- [files/to/map]] "
    exit 1
;;
esac
